name: Build Custom SST Containers from Git

on:
  workflow_dispatch:
    inputs:
      sst_core_repo:
        description: 'SST-core repository URL'
        required: false
        default: 'https://github.com/sstsimulator/sst-core.git'
        type: string
      sst_core_ref:
        description: 'SST-core branch, tag, or commit SHA'
        required: true
        type: string
      sst_elements_repo:
        description: 'SST-elements repository URL (leave empty for core-only build)'
        required: false
        type: string
      sst_elements_ref:
        description: 'SST-elements branch, tag, or commit SHA (required if elements_repo provided)'
        required: false
        type: string
      mpich_version:
        description: 'MPICH version to use'
        required: false
        default: '4.0.2'
        type: string
      build_platforms:
        description: 'Platforms to build for'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: choice
        options:
          - 'linux/amd64,linux/arm64'
          - 'linux/amd64'
          - 'linux/arm64'
      custom_tag_suffix:
        description: 'Optional tag suffix (default: short SHA of core ref)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/sst
  BUILD_NCPUS: 4

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      build_type: ${{ steps.validate.outputs.build_type }}
      core_short_sha: ${{ steps.validate.outputs.core_short_sha }}
      elements_short_sha: ${{ steps.validate.outputs.elements_short_sha }}
      tag_suffix: ${{ steps.validate.outputs.tag_suffix }}
      platforms: ${{ steps.validate.outputs.platforms }}
    steps:
      - name: Validate inputs
        id: validate
        run: |
          # Determine build type
          if [ -n "${{ inputs.sst_elements_repo }}" ]; then
            if [ -z "${{ inputs.sst_elements_ref }}" ]; then
              echo "::error::SST-elements ref is required when elements_repo is provided"
              exit 1
            fi
            echo "build_type=full" >> $GITHUB_OUTPUT
          else
            echo "build_type=core" >> $GITHUB_OUTPUT
          fi

          # Get short SHAs for tagging
          # For core
          CORE_SHA="${{ inputs.sst_core_ref }}"
          CORE_SHORT_SHA=$(echo "$CORE_SHA" | cut -c1-7)
          echo "core_short_sha=$CORE_SHORT_SHA" >> $GITHUB_OUTPUT

          # For elements (if provided)
          if [ -n "${{ inputs.sst_elements_ref }}" ]; then
            ELEMENTS_SHA="${{ inputs.sst_elements_ref }}"
            ELEMENTS_SHORT_SHA=$(echo "$ELEMENTS_SHA" | cut -c1-7)
            echo "elements_short_sha=$ELEMENTS_SHORT_SHA" >> $GITHUB_OUTPUT
          fi

          # Determine tag suffix
          if [ -n "${{ inputs.custom_tag_suffix }}" ]; then
            echo "tag_suffix=${{ inputs.custom_tag_suffix }}" >> $GITHUB_OUTPUT
          else
            # Extract repo owner from core repo URL
            REPO_URL="${{ inputs.sst_core_repo }}"
            REPO_OWNER=$(echo "$REPO_URL" | sed -E 's/.*[:/]([^/]+)\/[^/]+\.git/\1/')
            echo "tag_suffix=${REPO_OWNER}-${CORE_SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

          # Parse build platforms into JSON array for matrix
          PLATFORMS="${{ inputs.build_platforms }}"
          echo "platforms=$(echo "$PLATFORMS" | jq -R -c 'split(",")' )" >> $GITHUB_OUTPUT

          echo "::notice::Build type: $(cat $GITHUB_OUTPUT | grep build_type | cut -d= -f2)"
          echo "::notice::Tag suffix: $(cat $GITHUB_OUTPUT | grep tag_suffix | cut -d= -f2)"
          echo "::notice::Platforms: $PLATFORMS"

  download-mpich:
    runs-on: ubuntu-latest
    needs: validate-inputs
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache MPICH tarball
        uses: actions/cache@v4
        with:
          path: Containerfiles/*.tar.gz
          key: mpich-${{ inputs.mpich_version }}
          restore-keys: |
            mpich-

      - name: Download MPICH source
        run: |
          cd Containerfiles

          # Make download script executable
          chmod +x download_tarballs.sh

          # Check if MPICH tarball exists
          MPICH_FILE="mpich-${{ inputs.mpich_version }}.tar.gz"
          if [ -f "$MPICH_FILE" ]; then
            echo "MPICH tarball already exists, skipping download"
          else
            echo "Downloading MPICH ${{ inputs.mpich_version }}..."
            wget --no-check-certificate \
              https://www.mpich.org/static/downloads/${{ inputs.mpich_version }}/mpich-${{ inputs.mpich_version }}.tar.gz
          fi

          # List downloaded files
          echo "Files in Containerfiles directory:"
          ls -la *.tar.gz || echo "No tarballs found"

      - name: Upload MPICH artifact
        uses: actions/upload-artifact@v4
        with:
          name: mpich-${{ inputs.mpich_version }}
          path: Containerfiles/*.tar.gz
          retention-days: 1

  build-custom-containers:
    runs-on: ${{ matrix.platform == 'linux/arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    needs: [validate-inputs, download-mpich]
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        platform: ${{ fromJson(needs.validate-inputs.outputs.platforms) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download MPICH artifact
        uses: actions/download-artifact@v4
        with:
          name: mpich-${{ inputs.mpich_version }}
          path: Containerfiles/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract platform info
        id: platform
        run: |
          PLATFORM="${{ matrix.platform }}"
          ARCH="${PLATFORM##*/}"
          echo "arch=$ARCH" >> $GITHUB_OUTPUT
          echo "platform_safe=${PLATFORM//\//-}" >> $GITHUB_OUTPUT

      - name: Determine build target and tags
        id: build_info
        run: |
          BUILD_TYPE="${{ needs.validate-inputs.outputs.build_type }}"
          TAG_SUFFIX="${{ needs.validate-inputs.outputs.tag_suffix }}"

          ARCH="${{ steps.platform.outputs.arch }}"

          if [ "$BUILD_TYPE" = "full" ]; then
            echo "package_type=full" >> $GITHUB_OUTPUT
            echo "target=sst-full" >> $GITHUB_OUTPUT
            TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-full:${TAG_SUFFIX}-${ARCH}"
          else
            echo "package_type=core" >> $GITHUB_OUTPUT
            echo "target=sst-core" >> $GITHUB_OUTPUT
            TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-core:${TAG_SUFFIX}-${ARCH}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT

      - name: Build and push custom SST container
        uses: docker/build-push-action@v5
        with:
          context: Containerfiles
          file: Containerfiles/Containerfile.tag
          target: ${{ steps.build_info.outputs.target }}
          build-args: |
            SSTrepo=${{ inputs.sst_core_repo }}
            tag=${{ inputs.sst_core_ref }}
            SSTElementsRepo=${{ inputs.sst_elements_repo }}
            elementsTag=${{ inputs.sst_elements_ref }}
            mpich=${{ inputs.mpich_version }}
            NCPUS=${{ env.BUILD_NCPUS }}
          labels: |
            com.github.sha=${{ github.sha }}
            com.github.workflow=${{ github.workflow }}
            com.github.run_id=${{ github.run_id }}
            com.github.run_number=${{ github.run_number }}
            com.github.repository=${{ github.repository }}
            com.github.ref_name=${{ github.ref_name }}
          tags: ${{ steps.build_info.outputs.tags }}
          push: true
          cache-from: type=gha,scope=sst-custom-${{ needs.validate-inputs.outputs.build_type }}-${{ steps.platform.outputs.arch }}
          cache-to: type=gha,mode=max,scope=sst-custom-${{ needs.validate-inputs.outputs.build_type }}-${{ steps.platform.outputs.arch }}

  validate-containers:
    runs-on: ${{ matrix.platform == 'linux/arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    needs: [validate-inputs, build-custom-containers]
    permissions:
      contents: read
      packages: read
    strategy:
      matrix:
        platform: ${{ fromJson(needs.validate-inputs.outputs.platforms) }}
    steps:
      - name: Extract architecture
        id: arch
        run: |
          PLATFORM="${{ matrix.platform }}"
          ARCH="${PLATFORM##*/}"
          echo "arch=$ARCH" >> $GITHUB_OUTPUT

      - name: Validate container
        run: |
          BUILD_TYPE="${{ needs.validate-inputs.outputs.build_type }}"
          TAG_SUFFIX="${{ needs.validate-inputs.outputs.tag_suffix }}"
          ARCH="${{ steps.arch.outputs.arch }}"
          IMAGE_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${BUILD_TYPE}:${TAG_SUFFIX}-${ARCH}"

          echo "Validating container: $IMAGE_NAME"

          # Pull and run basic validation
          docker pull "$IMAGE_NAME"

          # Test SST installation
          echo "sst --version" | docker run --rm -i "$IMAGE_NAME"
          echo "sst-info --version" | docker run --rm -i "$IMAGE_NAME"

          # Get image size
          IMAGE_SIZE=$(docker image inspect "$IMAGE_NAME" --format='{{.Size}}')
          IMAGE_SIZE_MB=$((IMAGE_SIZE / 1024 / 1024))

          echo "Container validation successful!"
          echo "Image: $IMAGE_NAME"
          echo "Size: ${IMAGE_SIZE_MB} MB"
          echo "Platform: ${{ matrix.platform }}"
          echo "Type: SST-${BUILD_TYPE}"

  create-manifest-lists:
    runs-on: ubuntu-latest
    needs: [validate-inputs, build-custom-containers]
    if: needs.build-custom-containers.result == 'success'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-architecture manifest lists
        run: |
          BUILD_TYPE="${{ needs.validate-inputs.outputs.build_type }}"
          TAG_SUFFIX="${{ needs.validate-inputs.outputs.tag_suffix }}"

          # Determine which platforms were built
          PLATFORMS="${{ inputs.build_platforms }}"
          IFS=',' read -ra PLATFORM_ARRAY <<< "$PLATFORMS"

          echo "Creating manifest lists for platforms: ${PLATFORMS}"
          echo "Build type: ${BUILD_TYPE}"
          echo "Tag suffix: ${TAG_SUFFIX}"

          # Create manifest for the build type that was built
          echo "Creating manifest for ${BUILD_TYPE}..."
          MANIFESTS=""

          for platform in "${PLATFORM_ARRAY[@]}"; do
            ARCH="${platform#linux/}"
            TEMP_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${BUILD_TYPE}:${TAG_SUFFIX}-${ARCH}"
            echo "Checking: ${TEMP_TAG}"
            if docker manifest inspect "${TEMP_TAG}" >/dev/null 2>&1; then
              MANIFESTS="$MANIFESTS ${TEMP_TAG}"
              echo "  [OK] Added: ${TEMP_TAG}"
            fi
          done

          if [ -n "$MANIFESTS" ]; then
            MANIFEST_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${BUILD_TYPE}:${TAG_SUFFIX}"
            echo "Creating multi-arch manifest: ${MANIFEST_NAME}"
            docker buildx imagetools create --tag "${MANIFEST_NAME}" $MANIFESTS
            echo "[SUCCESS] Created manifest: ${MANIFEST_NAME}"
          else
            echo "[ERROR] No images found for ${BUILD_TYPE}"
            exit 1
          fi

          echo "[SUCCESS] Custom SST manifest created successfully"
          echo "Users can now pull: ${MANIFEST_NAME}"

  summary:
    runs-on: ubuntu-latest
    needs: [validate-inputs, build-custom-containers, validate-containers, create-manifest-lists]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Build Summary
        run: |
          echo "# Custom SST Container Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type:** ${{ needs.validate-inputs.outputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**SST-Core Repository:** ${{ inputs.sst_core_repo }}" >> $GITHUB_STEP_SUMMARY
          echo "**SST-Core Ref:** ${{ inputs.sst_core_ref }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-inputs.outputs.build_type }}" = "full" ]; then
            echo "**SST-Elements Repository:** ${{ inputs.sst_elements_repo }}" >> $GITHUB_STEP_SUMMARY
            echo "**SST-Elements Ref:** ${{ inputs.sst_elements_ref }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**MPICH Version:** ${{ inputs.mpich_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Platforms:** ${{ inputs.build_platforms }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag Suffix:** ${{ needs.validate-inputs.outputs.tag_suffix }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.create-manifest-lists.result }}" == "success" ]; then
            echo "**Build Status:** Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Built Containers" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Multi-architecture manifest (recommended):**" >> $GITHUB_STEP_SUMMARY
            echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ needs.validate-inputs.outputs.build_type }}:${{ needs.validate-inputs.outputs.tag_suffix }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Architecture-specific images:**" >> $GITHUB_STEP_SUMMARY
            PLATFORMS="${{ inputs.build_platforms }}"
            for PLATFORM in ${PLATFORMS//,/ }; do
              ARCH="${PLATFORM##*/}"
              echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ needs.validate-inputs.outputs.build_type }}:${{ needs.validate-inputs.outputs.tag_suffix }}-${ARCH}\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "**Build Status:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pull and use the container:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY

          echo "# Pull the multi-arch container (auto-selects architecture)" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ needs.validate-inputs.outputs.build_type }}:${{ needs.validate-inputs.outputs.tag_suffix }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Run the container" >> $GITHUB_STEP_SUMMARY
          echo "docker run -it ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ needs.validate-inputs.outputs.build_type }}:${{ needs.validate-inputs.outputs.tag_suffix }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Container Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Core Ref:** \`${{ inputs.sst_core_ref }}\` (short: \`${{ needs.validate-inputs.outputs.core_short_sha }}\`)" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ needs.validate-inputs.outputs.elements_short_sha }}" ]; then
            echo "- **Elements Ref:** \`${{ inputs.sst_elements_ref }}\` (short: \`${{ needs.validate-inputs.outputs.elements_short_sha }}\`)" >> $GITHUB_STEP_SUMMARY
          fi

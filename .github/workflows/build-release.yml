name: Build SST Release Containers

# Build containers from official SST releases
# Creates both core and full variants from stable release tarballs

on:
  workflow_dispatch:
    inputs:
      sst_version:
        description: 'SST version to build (e.g., 15.1.0, 15.0.0)'
        required: true
        type: string
      container_types:
        description: 'Container types to build'
        required: false
        default: 'core,full'
        type: choice
        options:
          - 'core,full'
          - 'core'
          - 'full'
      mpich_version:
        description: 'MPICH version to use'
        required: false
        default: '4.0.2'
        type: string
      force_rebuild:
        description: 'Force rebuild even if containers exist'
        required: false
        default: false
        type: boolean
      ignore_cache:
        description: 'Ignore cached tarballs and redownload'
        required: false
        default: false
        type: boolean
      build_platforms:
        description: 'Platforms to build for'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: choice
        options:
          - 'linux/amd64,linux/arm64'
          - 'linux/amd64'
          - 'linux/arm64'
      tag_as_latest:
        description: 'Also tag this version as "latest"'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io

jobs:
  build-core-containers:
    if: contains(inputs.container_types, 'core')
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/_reusable-build-containers.yml
    with:
      container_type: 'core'
      image_prefix: '${{ github.repository_owner }}/sst'
      tag_suffix: '${{ inputs.sst_version }}'
      build_platforms: '${{ inputs.build_platforms }}'
      sst_version: '${{ inputs.sst_version }}'
      mpich_version: '${{ inputs.mpich_version }}'
      containerfile_path: 'Containerfiles/Containerfile'
      docker_context: 'Containerfiles'
      build_target: 'sst-core'
      force_rebuild: ${{ inputs.force_rebuild }}
      ignore_cache: ${{ inputs.ignore_cache }}
    secrets: inherit

  build-full-containers:
    if: contains(inputs.container_types, 'full')
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/_reusable-build-containers.yml
    with:
      container_type: 'full'
      image_prefix: '${{ github.repository_owner }}/sst'
      tag_suffix: '${{ inputs.sst_version }}'
      build_platforms: '${{ inputs.build_platforms }}'
      sst_version: '${{ inputs.sst_version }}'
      mpich_version: '${{ inputs.mpich_version }}'
      containerfile_path: 'Containerfiles/Containerfile'
      docker_context: 'Containerfiles'
      build_target: 'sst-full'
      force_rebuild: ${{ inputs.force_rebuild }}
      ignore_cache: ${{ inputs.ignore_cache }}
    secrets: inherit

  validate-core-containers:
    if: contains(inputs.container_types, 'core') && needs.build-core-containers.result == 'success'
    permissions:
      contents: read
      packages: read
    uses: ./.github/workflows/_reusable-validate-containers.yml
    needs: [build-core-containers]
    with:
      container_type: 'core'
      image_tags: '${{ needs.build-core-containers.outputs.built_images }}'
      build_platforms: '${{ inputs.build_platforms }}'
      max_image_size_mb: 2048  # 2GB - enough for core
    secrets: inherit

  validate-full-containers:
    if: contains(inputs.container_types, 'full') && needs.build-full-containers.result == 'success'
    permissions:
      contents: read
      packages: read
    uses: ./.github/workflows/_reusable-validate-containers.yml
    needs: [build-full-containers]
    with:
      container_type: 'full'
      image_tags: '${{ needs.build-full-containers.outputs.built_images }}'
      build_platforms: '${{ inputs.build_platforms }}'
      max_image_size_mb: 4096  # 4GB - full build is larger
    secrets: inherit

  generate-summary:
    uses: ./.github/workflows/_reusable-generate-summary.yml
    needs: [build-core-containers, build-full-containers, validate-core-containers, validate-full-containers]
    if: always()
    with:
      workflow_type: 'release'
      container_type: '${{ inputs.container_types }}'
      build_successful: ${{ (needs.build-core-containers.result == 'success' || needs.build-core-containers.result == 'skipped') && (needs.build-full-containers.result == 'success' || needs.build-full-containers.result == 'skipped') }}
      manifest_successful: ${{ (needs.build-core-containers.result == 'success' || needs.build-core-containers.result == 'skipped') && (needs.build-full-containers.result == 'success' || needs.build-full-containers.result == 'skipped') }}
      validation_successful: ${{ (needs.validate-core-containers.result == 'success' || needs.validate-core-containers.result == 'skipped') && (needs.validate-full-containers.result == 'success' || needs.validate-full-containers.result == 'skipped') }}
      manifest_tag: '${{ needs.build-core-containers.outputs.manifest_tag || needs.build-full-containers.outputs.manifest_tag }}'
      built_images: '${{ needs.build-core-containers.outputs.built_images || needs.build-full-containers.outputs.built_images }}'
      build_platforms: '${{ inputs.build_platforms }}'
      tag_suffix: '${{ inputs.sst_version }}'
      sst_version: '${{ inputs.sst_version }}'
      mpich_version: '${{ inputs.mpich_version }}'

  # Optional: Tag as latest if requested
  tag-as-latest:
    runs-on: ubuntu-latest
    needs: [build-core-containers, build-full-containers]
    if: inputs.tag_as_latest && ((needs.build-core-containers.result == 'success' || needs.build-core-containers.result == 'skipped') && (needs.build-full-containers.result == 'success' || needs.build-full-containers.result == 'skipped'))
    permissions:
      contents: read
      packages: write
    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag containers as latest
        run: |
          echo "Tagging SST ${{ inputs.sst_version }} containers as 'latest'"

          if [[ "${{ inputs.container_types }}" == *"core"* ]]; then
            SOURCE_TAG="${{ env.REGISTRY }}/${{ github.repository_owner }}/sst-core:${{ inputs.sst_version }}"
            LATEST_TAG="${{ env.REGISTRY }}/${{ github.repository_owner }}/sst-core:latest"
            echo "Tagging core: $SOURCE_TAG -> $LATEST_TAG"
            docker buildx imagetools create --tag "$LATEST_TAG" "$SOURCE_TAG"
          fi

          if [[ "${{ inputs.container_types }}" == *"full"* ]]; then
            SOURCE_TAG="${{ env.REGISTRY }}/${{ github.repository_owner }}/sst-full:${{ inputs.sst_version }}"
            LATEST_TAG="${{ env.REGISTRY }}/${{ github.repository_owner }}/sst-full:latest"
            echo "Tagging full: $SOURCE_TAG -> $LATEST_TAG"
            docker buildx imagetools create --tag "$LATEST_TAG" "$SOURCE_TAG"
          fi

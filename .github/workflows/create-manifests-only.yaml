name: Create Multi-Architecture Manifests (Existing Images)

on:
  workflow_dispatch:
    inputs:
      sst_version:
        description: 'SST version to create manifests for (e.g., 15.1.0, 14.1.0) - not required for experiments'
        required: false
        type: string
      mpich_version:
        description: 'MPICH version (for dev containers)'
        required: false
        default: '4.0.2'
        type: string
      container_types:
        description: 'Container types to create manifests for'
        required: false
        default: 'core,full,dev'
        type: choice
        options:
          - 'core,full,dev'
          - 'core,full'
          - 'core'
          - 'full'
          - 'dev'
          - 'experiment'
      experiment_name:
        description: 'Experiment name (required if container_types includes "experiment")'
        required: false
        type: string
      experiment_tag:
        description: 'Experiment tag (default: latest)'
        required: false
        default: 'latest'
        type: string
      platforms:
        description: 'Platforms to include in manifest'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: choice
        options:
          - 'linux/amd64,linux/arm64'
          - 'linux/amd64'
          - 'linux/arm64'
      tag_as_latest:
        description: 'Also create "latest" manifests'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  RELEASE_IMAGE_PREFIX: ${{ github.repository_owner }}/sst
  DEV_IMAGE_PREFIX: ${{ github.repository_owner }}/sst-dev

jobs:
  create-manifests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-architecture manifest lists
        run: |
          SST_VERSION="${{ inputs.sst_version }}"
          MPICH_VERSION="${{ inputs.mpich_version }}"
          TAG_LATEST="${{ inputs.tag_as_latest }}"
          CONTAINER_TYPES="${{ inputs.container_types }}"

          # Parse platforms into array
          PLATFORMS="${{ inputs.platforms }}"
          IFS=',' read -ra PLATFORM_ARRAY <<< "$PLATFORMS"

          # Parse container types into array
          IFS=',' read -ra TYPE_ARRAY <<< "$CONTAINER_TYPES"

          # Validate required inputs based on container types
          for container_type in "${TYPE_ARRAY[@]}"; do
            case "$container_type" in
              "core"|"full"|"dev")
                if [ -z "$SST_VERSION" ]; then
                  echo "[ERROR] sst_version is required when container_types includes 'core', 'full', or 'dev'"
                  exit 1
                fi
                ;;
              "experiment")
                EXPERIMENT_NAME="${{ inputs.experiment_name }}"
                if [ -z "$EXPERIMENT_NAME" ]; then
                  echo "[ERROR] experiment_name is required when container_types includes 'experiment'"
                  exit 1
                fi
                ;;
            esac
          done

          echo "Creating manifest lists for:"
          echo "- SST Version: $SST_VERSION"
          echo "- MPICH Version: $MPICH_VERSION"
          echo "- Container Types: $CONTAINER_TYPES"
          echo "- Platforms: $PLATFORMS"
          echo "- Tag as Latest: $TAG_LATEST"
          echo ""

          # Function to create manifest list using buildx imagetools
          create_manifest() {
            local image_base="$1"
            local tag="$2"

            echo "Creating manifest for: ${image_base}:${tag}"

            # Build list of source images (ARM64 first for preferred ordering)
            local source_images=""
            local found_images=""

            # First pass: collect all available images
            for platform in "${PLATFORM_ARRAY[@]}"; do
              ARCH="${platform#linux/}"
              SOURCE_IMAGE="${{ env.REGISTRY }}/${image_base}-${ARCH}:${tag}"

              echo "  Checking: $SOURCE_IMAGE"
              if docker manifest inspect "$SOURCE_IMAGE" >/dev/null 2>&1; then
                found_images="$found_images $ARCH:$SOURCE_IMAGE"
                echo "    [OK] Found"
              else
                echo "    [MISS] Not found"
              fi
            done

            # Second pass: add images in preferred order (ARM64 first, then AMD64)
            for preferred_arch in "arm64" "amd64"; do
              for img_entry in $found_images; do
                arch="${img_entry%%:*}"
                img="${img_entry#*:}"
                if [ "$arch" = "$preferred_arch" ]; then
                  source_images="$source_images $img"
                fi
              done
            done

            if [ -z "$source_images" ]; then
              echo "  [ERROR] No source images found for $image_base:$tag"
              return 1
            fi

            echo "  Creating multi-arch manifest from:$source_images"

            # Use buildx imagetools to create the multi-arch manifest
            docker buildx imagetools create \
              --tag ${{ env.REGISTRY }}/${image_base}:${tag} \
              $source_images

            echo "  [SUCCESS] Created: ${{ env.REGISTRY }}/${image_base}:${tag}"
            echo ""
          }          # Process each container type
          for container_type in "${TYPE_ARRAY[@]}"; do
            case "$container_type" in
              "core")
                create_manifest "${{ env.RELEASE_IMAGE_PREFIX }}-core" "$SST_VERSION"
                if [ "$TAG_LATEST" = "true" ]; then
                  create_manifest "${{ env.RELEASE_IMAGE_PREFIX }}-core" "latest"
                fi
                ;;
              "full")
                create_manifest "${{ env.RELEASE_IMAGE_PREFIX }}-full" "$SST_VERSION"
                if [ "$TAG_LATEST" = "true" ]; then
                  create_manifest "${{ env.RELEASE_IMAGE_PREFIX }}-full" "latest"
                fi
                ;;
              "dev")
                create_manifest "${{ env.DEV_IMAGE_PREFIX }}" "latest"
                # Also create MPICH-specific tag if different from latest
                if [ "$MPICH_VERSION" != "4.0.2" ]; then
                  create_manifest "${{ env.DEV_IMAGE_PREFIX }}" "mpich-$MPICH_VERSION"
                fi
                ;;
              "experiment")
                EXPERIMENT_NAME="${{ inputs.experiment_name }}"
                EXPERIMENT_TAG="${{ inputs.experiment_tag }}"
                create_manifest "${{ github.repository_owner }}/$EXPERIMENT_NAME" "$EXPERIMENT_TAG"
                ;;
            esac
          done

          echo "================================"
          echo "All manifest lists created successfully!"
          echo ""
          echo "Users can now pull:"
          for container_type in "${TYPE_ARRAY[@]}"; do
            case "$container_type" in
              "core")
                echo "  docker pull ${{ env.REGISTRY }}/${{ env.RELEASE_IMAGE_PREFIX }}-core:$SST_VERSION"
                if [ "$TAG_LATEST" = "true" ]; then
                  echo "  docker pull ${{ env.REGISTRY }}/${{ env.RELEASE_IMAGE_PREFIX }}-core:latest"
                fi
                ;;
              "full")
                echo "  docker pull ${{ env.REGISTRY }}/${{ env.RELEASE_IMAGE_PREFIX }}-full:$SST_VERSION"
                if [ "$TAG_LATEST" = "true" ]; then
                  echo "  docker pull ${{ env.REGISTRY }}/${{ env.RELEASE_IMAGE_PREFIX }}-full:latest"
                fi
                ;;
              "dev")
                echo "  docker pull ${{ env.REGISTRY }}/${{ env.DEV_IMAGE_PREFIX }}:latest"
                ;;
              "experiment")
                EXPERIMENT_NAME="${{ inputs.experiment_name }}"
                EXPERIMENT_TAG="${{ inputs.experiment_tag }}"
                echo "  docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/$EXPERIMENT_NAME:$EXPERIMENT_TAG"
                ;;
            esac
          done

      - name: Verify manifests
        run: |
          SST_VERSION="${{ inputs.sst_version }}"
          CONTAINER_TYPES="${{ inputs.container_types }}"
          TAG_LATEST="${{ inputs.tag_as_latest }}"

          IFS=',' read -ra TYPE_ARRAY <<< "$CONTAINER_TYPES"

          echo "Verifying created manifests:"
          echo ""

          for container_type in "${TYPE_ARRAY[@]}"; do
            case "$container_type" in
              "core")
                echo "=== ${{ env.RELEASE_IMAGE_PREFIX }}-core:$SST_VERSION ==="
                docker manifest inspect ${{ env.REGISTRY }}/${{ env.RELEASE_IMAGE_PREFIX }}-core:$SST_VERSION --verbose | grep -E "(mediaType|platform)"
                if [ "$TAG_LATEST" = "true" ]; then
                  echo "=== ${{ env.RELEASE_IMAGE_PREFIX }}-core:latest ==="
                  docker manifest inspect ${{ env.REGISTRY }}/${{ env.RELEASE_IMAGE_PREFIX }}-core:latest --verbose | grep -E "(mediaType|platform)"
                fi
                ;;
              "full")
                echo "=== ${{ env.RELEASE_IMAGE_PREFIX }}-full:$SST_VERSION ==="
                docker manifest inspect ${{ env.REGISTRY }}/${{ env.RELEASE_IMAGE_PREFIX }}-full:$SST_VERSION --verbose | grep -E "(mediaType|platform)"
                if [ "$TAG_LATEST" = "true" ]; then
                  echo "=== ${{ env.RELEASE_IMAGE_PREFIX }}-full:latest ==="
                  docker manifest inspect ${{ env.REGISTRY }}/${{ env.RELEASE_IMAGE_PREFIX }}-full:latest --verbose | grep -E "(mediaType|platform)"
                fi
                ;;
              "dev")
                echo "=== SST-DEV:LATEST ==="
                docker manifest inspect ${{ env.REGISTRY }}/${{ env.DEV_IMAGE_PREFIX }}:latest --verbose | grep -E "(mediaType|platform)"
                ;;
              "experiment")
                EXPERIMENT_NAME="${{ inputs.experiment_name }}"
                EXPERIMENT_TAG="${{ inputs.experiment_tag }}"
                echo "=== $EXPERIMENT_NAME:$EXPERIMENT_TAG ==="
                docker manifest inspect ${{ env.REGISTRY }}/${{ github.repository_owner }}/$EXPERIMENT_NAME:$EXPERIMENT_TAG --verbose | grep -E "(mediaType|platform)"
                ;;
            esac
            echo ""
          done